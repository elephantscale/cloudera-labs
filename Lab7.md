# Lab 7 - Working with Data Sets in Apache Pig

In this lab, we will learn about various processing operations offered by Apache Pig for handling data sets. In our work, we will use Grunt, Pig's interactive shell.

## Part 1 - Connect to the Lab Environment

Note: Skip this Lab Part if you are using the Lab Server's desktop environment setup.

Using your SSH client, connect to the Lab Environment. Use cloudera/cloudera credentials when prompted.

## Part 2 - The Lab Working Directory

All the steps in this lab will be performed in the /home/cloudera/Works directory.

1. In the terminal window, type in the following command:

```bash
cd ~/Works
```

## Part 3 - Working with the Data Set

In this lab we will be working with the files.dat file located in your ~/LabFiles folder. Also, to speed things up a bit and facilitate the learning process, we will run Pig in local mode.

1. Enter the following command to copy the files.dat file to the current directory:

```bash
cp ~/LabFiles/files.dat .
```

2. Enter the following command to start Grunt in local mode:

```bash
pig -x local
```

You should get the Grunt shell prompt.

```console
grunt>
```

Note: Don't forget the closing ; (semi-colon) after each Pig Latin statement.



3. Enter the following command (in one line):

```pig
lines = LOAD 'files.dat' USING PigStorage (',') AS (name:chararray, size:int, month:chararray);
```

This command will create a lines relation from the files.dat local file.

4. Enter the following command to skip all the tuples that don't have values Feb or Mar in the month field:

```pig
lines_filtered = FILTER lines BY (month == 'Feb') OR (month == 'Mar');
```

5. Enter the following commands (press Enter after each line):

```pig
x = GROUP lines_filtered ALL; y = FOREACH x GENERATE group, COUNT(lines_filtered ); DUMP y;
```

The above commands will perform a global count of the number of tuples (rows) in the lines_filtered relation and dump the output to console.

```console
(all,281)
```

You can verify this result by running the following commands against the files.dat in the Works directory; you can do so after finishing the current Grunt session or by opening another terminal window and navigating to the /home/cloudera/Works directory).

```bash
grep Mar files.dat | wc -l 
grep Feb files.dat | wc -l
```

(should show 2 hits) (should show 279 hits)

Now let's see how we can find the maximum file size created in each month.

6. Enter the following commands (press Enter after each line):

```pig
grouped_by_month = GROUP lines BY month; max_in_month = FOREACH grouped_by_month GENERATE group, MAX (lines.size); DUMP max_in_month;
```



57 After the MapReduce job compiled by Pig completes, you should see the following output (your result may differ):

```console
(Apr,2313400) (Aug,988432) (Dec,1780488) (Feb,8713256) (Jan,75688) (Jul,716264) (Jun,1896560) (Mar,499352) (May,222776) (Nov,768448) (Oct,702048) (Sep,641096)
```

Now we may want to persist the results and that's how we can do it. 7. Enter the following command:

```pig
STORE max_in_month INTO 'max_in_month' USING PigStorage ('|');
```

We use the USING PigStorage ('|') function to instruct Pig to use the '|' for a field delimiter rather than the default Tab character.

Pig also supports a number of compression codecs (gz, bz, and bz2) when saving files on the persistent storage (local file system or HDFS). All you need is to specify the compressed file extension recognized by Pig when storing the file using the STORE function (for more information on handling compression, visit http://pig.apache.org/docs/ r0.12.0/func.html#load-store-functions) Let's see how you can save the lines_filtered relation we worked on earlier in this lab in the GZIP codec.

8. Enter the following command:

```pig
STORE lines_filtered INTO 'lines_filtered.gz';
```

We are done with the Grant session; let's review the output we created using the STORE function.

9. Type in quit and press Enter to close the Grunt command shell.

You should be returned to the system command prompt.

10. Enter the following command:

```bash
find .
```



58 You should see all the files and directories in the Works folder.

```console
./max_in_month 
./max_in_month/.part-r-00000.crc 
./max_in_month/._SUCCESS.crc 
./max_in_month/part-r-00000 
./max_in_month/_SUCCESS 
./files.dat 
./lines_filtered.gz 
./lines_filtered.gz/._SUCCESS.crc 
./lines_filtered.gz/part-m-00000.gz 
./lines_filtered.gz/.part-m-00000.gz.crc 
./lines_filtered.gz/_SUCCESS
```

Of interest to us are two files:

```console
./max_in_month/part-r-00000 
./lines_filtered.gz/part-m-00000.gz
```

The `./max_in_month/part-r-00000` file was generated by the `STORE max_in_month INTO 'max_in_month' USING PigStorage ('|');` command; go ahead to open and review it.

The `./lines_filtered.gz/part-m-00000.gz` was created using the `STORE max_in_month INTO 'max_in_month.gz';` statement.

11. Enter the following command:

```bash
gunzip -lv ./lines_filtered.gz/part-m-00000.gz
```

You should see the following output:

```console
method crc date time defla aacaa16f Jun 26 15:57

compressed 2510

uncompressed 5841

ratio uncompressed_name 57.5% ./lines_filtered.gz/part-m-00000
```

You can also decompress the file using this command:

```bash
gunzip -d
```

```console
./lines_filtered.gz/part-m-00000.gz
```

We are almost done in this lab.

## Part 4 - Working Area Clean-up

1. Enter the following command:

```bash
cd /home/cloudera/Works
```

2. Enter the following command:

```bash
pwd
```

You should see the following output:

```console
/home/cloudera/Works
```
3. Enter the following command:

```bash
rm -fr *
```

## Part 5 - Ending the Working Session

1. Type in exit and press Enter to close your terminal window.

This is the last step in this lab.

## Part 6 - Review

In this lab, we familiarized ourselves with Pig Latin's various operators: FILTER, GROUP (as applied in global and group context), and FOREACH. We also familiarized ourselves with a way to save work results in a compressed format.
